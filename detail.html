<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô - Action.in.th</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#0f172a', 600: '#020617' }, // Theme ‡∏™‡∏µ‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤-‡∏î‡∏≥ ‡∏î‡∏π‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏≠‡∏≤‡∏î
                        accent: { 500: '#22c55e', 600: '#16a34a' } // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Action
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; }
        
        /* Input Compact Style */
        .form-input {
            width: 100%; padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1; border-radius: 0.375rem;
            background-color: #fff; font-size: 0.9rem; transition: all 0.2s;
        }
        .form-input:focus { border-color: #0f172a; outline: none; ring: 1px solid #0f172a; }
        label { font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 0.2rem; display: block; }

        /* Ticket Compact Style */
        .ticket-item {
            border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;
            background: white; cursor: pointer; transition: all 0.2s;
            margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;
        }
        .ticket-item:hover { border-color: #94a3b8; background-color: #f8fafc; }
        .ticket-item.selected {
            border-color: #22c55e; background-color: #f0fdf4; ring: 1px solid #22c55e;
        }
        .check-circle {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center;
        }
        .ticket-item.selected .check-circle { border-color: #22c55e; background: #22c55e; }
        .ticket-item.selected .check-circle::after { content: '‚úì'; color: white; font-size: 12px; font-weight: bold; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-white border-b border-slate-200 h-14 sticky top-0 z-50 flex items-center shadow-sm">
        <div class="container mx-auto px-4 max-w-6xl flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 font-bold text-lg text-slate-800">
                <span class="bg-slate-900 text-white w-7 h-7 rounded flex items-center justify-center text-sm">A</span> Action.in.th
            </a>
            <a href="index.html" class="text-xs font-bold text-slate-400 hover:text-slate-600">‚úï CANCEL</a>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-6 max-w-6xl">
        
        <div class="flex flex-col md:flex-row gap-6 mb-6 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
            <img id="event-img" src="" class="w-full md:w-48 h-32 object-cover rounded-lg bg-slate-100">
            <div class="flex flex-col justify-center">
                <h1 id="event-title" class="text-2xl font-bold text-slate-900 mb-2">Event Title</h1>
                <div class="text-sm text-slate-500 space-y-1">
                    <p>üìÖ <span id="event-date">-</span></p>
                    <p>üìç <span id="event-loc">-</span></p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-8">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h2 class="font-bold text-lg text-slate-800">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>
                        <button onclick="resetForm()" class="text-xs text-slate-400 underline hover:text-red-500">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                    </div>

                    <form id="runner-form" onsubmit="addToCart(event)" class="space-y-5">
                        
                        <div class="grid grid-cols-6 gap-3">
                            <div class="col-span-3"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á (First Name)</label><input type="text" id="reg-fname" class="form-input" required></div>
                            <div class="col-span-3"><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Last Name)</label><input type="text" id="reg-lname" class="form-input" required></div>
                            <div class="col-span-6 md:col-span-3"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä. (ID Card)</label><input type="text" id="reg-idcard" class="form-input" required></div>
                            <div class="col-span-2 md:col-span-1"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input type="date" id="reg-birth" class="form-input" required></div>
                            <div class="col-span-2 md:col-span-1"><label>‡πÄ‡∏û‡∏®</label><select id="reg-gender" class="form-input"><option value="Male">‡∏ä‡∏≤‡∏¢</option><option value="Female">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
                            <div class="col-span-2 md:col-span-1"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏î</label><select id="reg-blood" class="form-input"><option value="">-</option><option value="A">A</option><option value="B">B</option><option value="O">O</option><option value="AB">AB</option></select></div>
                            <div class="col-span-3"><label>‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥</label><input type="text" id="reg-nation" value="Thai" class="form-input"></div>
                        </div>

                        <div class="border-t pt-4 grid grid-cols-6 gap-3">
                            <div class="col-span-6"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (Address)</label><input type="text" id="reg-address" class="form-input"></div>
                            <div class="col-span-3"><label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="reg-province" class="form-input"></div>
                            <div class="col-span-3"><label>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label><input type="text" id="reg-zip" class="form-input"></div>
                            <div class="col-span-3"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="reg-phone" class="form-input" required></div>
                            <div class="col-span-3"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="reg-email" class="form-input" required></div>
                        </div>

                        <div class="border-t pt-4 grid grid-cols-6 gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div class="col-span-3"><label>BIB Name (ENG)</label><input type="text" id="reg-bib" class="form-input uppercase" maxlength="10" required></div>
                            <div class="col-span-3"><label>‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠</label><select id="reg-size" class="form-input"><option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>2XL</option></select></div>
                            
                            <div class="col-span-3"><label>‡∏ä‡∏°‡∏£‡∏°‡∏ß‡∏¥‡πà‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="reg-club" class="form-input"></div>
                            
                            <div class="col-span-3"><label>‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</label><select id="reg-ship" class="form-input"><option value="pickup">‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option><option value="post">‡∏™‡πà‡∏á ‡∏õ‡∏ì. (+50‡∏ö.)</option></select></div>
                        </div>

                        <div class="border-t pt-4 grid grid-cols-6 gap-3">
                            <div class="col-span-2"><label>‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</label><input type="text" id="reg-em-name" class="form-input" required></div>
                            
                            <div class="col-span-2"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label><input type="text" id="reg-em-rel" class="form-input" required></div>
                            
                            <div class="col-span-2"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</label><input type="tel" id="reg-em-phone" class="form-input" required></div>
                            <div class="col-span-6"><label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß / ‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input type="text" id="reg-med" class="form-input" value="-"></div>
                        </div>

                        <button type="submit" class="w-full py-3 bg-slate-800 hover:bg-black text-white font-bold rounded-lg shadow-sm transition mt-2">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (Add to Cart)
                        </button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm sticky top-20">
                    <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-slate-800 text-white flex items-center justify-center text-xs">1</span>
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£ (Select Ticket)
                    </h3>
                    <div id="ticket-options" class="flex flex-col">
                        </div>
                    <input type="hidden" id="selected-ticket-idx">
                    <p id="ticket-error" class="hidden text-xs text-red-500 mt-2 font-bold">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡πà‡∏≠‡∏ô</p>
                </div>

                <div id="cart-panel" class="bg-white rounded-xl border border-slate-200 shadow-lg overflow-hidden hidden sticky top-[450px]">
                    <div class="bg-slate-100 p-3 border-b border-slate-200 flex justify-between items-center">
                        <span class="font-bold text-sm text-slate-700">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                        <span id="cart-count" class="bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <div id="cart-items" class="max-h-48 overflow-y-auto p-3 space-y-2 text-sm custom-scroll bg-white">
                        </div>
                    <div class="p-4 border-t border-slate-200 bg-slate-50">
                        <div class="flex justify-between items-end mb-3">
                            <span class="text-xs text-slate-500">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <span class="text-xl font-bold text-accent-600" id="cart-total">0 ‡∏ø</span>
                        </div>
                        <button onclick="submitAll()" class="w-full bg-accent-600 hover:bg-accent-500 text-white font-bold py-2 rounded-lg text-sm shadow-sm transition">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="mobile-cart" class="hidden fixed bottom-0 w-full bg-white border-t p-3 shadow-lg z-50 flex justify-between items-center lg:hidden">
        <div>
            <div class="text-[10px] text-slate-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (<span id="mob-count">0</span>)</div>
            <div class="font-bold text-accent-600" id="mob-total">0 ‡∏ø</div>
        </div>
        <div class="flex gap-2">
            <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="px-3 py-2 border rounded text-xs font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å</button>
            <button onclick="submitAll()" class="px-4 py-2 bg-accent-600 text-white rounded text-xs font-bold">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        let currentEvent = null, cart = [];

        async function init() {
            if (!eventId) return alert('No ID');
            try {
                const res = await fetch(`${API_URL}/${eventId}`);
                currentEvent = await res.json();

                // Bind Data
                document.getElementById('event-img').src = currentEvent.image || 'https://via.placeholder.com/800x400';
                document.getElementById('event-title').innerText = currentEvent.title_th;
                document.getElementById('event-date').innerText = currentEvent.date;
                document.getElementById('event-loc').innerText = currentEvent.location_th;

                renderTickets();
            } catch (err) { console.error(err); }
        }

        function renderTickets() {
            const container = document.getElementById('ticket-options');
            const today = new Date().toISOString().split('T')[0];
            let tickets = currentEvent.tickets?.length ? currentEvent.tickets : (currentEvent.distance || 'General').split(',').map(d => ({ name: d.trim(), price: parseInt(currentEvent.price) || 0 }));
            currentEvent.processedTickets = tickets;

            container.innerHTML = tickets.map((t, idx) => {
                let finalPrice = t.price;
                let isEarly = (t.earlyBirdPrice && t.earlyBirdDate && today <= t.earlyBirdDate);
                if (isEarly) finalPrice = t.earlyBirdPrice;

                return `
                <div onclick="selectTicket(${idx})" id="ticket-${idx}" class="ticket-item">
                    <div>
                        <div class="font-bold text-slate-800">${t.name}</div>
                        ${isEarly ? '<span class="text-[10px] text-red-500 font-bold bg-red-50 px-1 rounded">Early Bird</span>' : '<span class="text-[10px] text-slate-400">Regular</span>'}
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            ${isEarly ? `<div class="text-[10px] text-slate-400 line-through">${t.price}</div>` : ''}
                            <div class="font-bold text-accent-600">${finalPrice} ‡∏ø</div>
                        </div>
                        <div class="check-circle"></div>
                    </div>
                </div>`;
            }).join('');
        }

        function selectTicket(idx) {
            document.querySelectorAll('.ticket-item').forEach(el => el.classList.remove('selected'));
            document.getElementById(`ticket-${idx}`).classList.add('selected');
            document.getElementById('selected-ticket-idx').value = idx;
            document.getElementById('ticket-error').classList.add('hidden');
        }

        function addToCart(e) {
            e.preventDefault();
            const idx = document.getElementById('selected-ticket-idx').value;
            if (idx === "") { document.getElementById('ticket-error').classList.remove('hidden'); return; }

            const ticket = currentEvent.processedTickets[idx];
            const today = new Date().toISOString().split('T')[0];
            let price = ticket.price;
            if (ticket.earlyBirdPrice && ticket.earlyBirdDate && today <= ticket.earlyBirdDate) price = ticket.earlyBirdPrice;

            // ‚úÖ Collect Data (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å ID ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô HTML ‡πÅ‡∏•‡πâ‡∏ß)
            const runner = {
                tempId: Date.now(),
                eventId: currentEvent._id,
                eventName: currentEvent.title_th,
                distance: ticket.name,
                price: price,
                firstName: document.getElementById('reg-fname').value,
                lastName: document.getElementById('reg-lname').value,
                nationalId: document.getElementById('reg-idcard').value,
                birthDate: document.getElementById('reg-birth').value,
                nationality: document.getElementById('reg-nation').value,
                bloodType: document.getElementById('reg-blood').value,
                gender: document.getElementById('reg-gender').value,
                address: document.getElementById('reg-address').value,
                province: document.getElementById('reg-province').value,
                zipcode: document.getElementById('reg-zip').value,
                phone: document.getElementById('reg-phone').value,
                email: document.getElementById('reg-email').value,
                emergencyName: document.getElementById('reg-em-name').value,
                emergencyRelation: document.getElementById('reg-em-rel').value, // Fixed missing
                emergencyPhone: document.getElementById('reg-em-phone').value,
                medicalCondition: document.getElementById('reg-med').value,
                bibName: document.getElementById('reg-bib').value.toUpperCase(),
                shirtSize: document.getElementById('reg-size').value,
                runningClub: document.getElementById('reg-club').value, // Fixed missing
                shippingMethod: document.getElementById('reg-ship').value,
                paymentStatus: 'pending'
            };

            cart.push(runner);
            renderCart();
            resetForm();
            alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß!');
        }

        function resetForm() {
            ['reg-fname','reg-lname','reg-idcard','reg-bib','reg-club'].forEach(id => document.getElementById(id).value = '');
            // Deselect ticket to force choice
            document.getElementById('selected-ticket-idx').value = "";
            document.querySelectorAll('.ticket-item').forEach(el => el.classList.remove('selected'));
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function renderCart() {
            const panel = document.getElementById('cart-panel');
            const mobilePanel = document.getElementById('mobile-cart');
            
            if (cart.length > 0) { 
                panel.classList.remove('hidden'); 
                mobilePanel.classList.remove('hidden'); mobilePanel.classList.add('flex');
            } else { 
                panel.classList.add('hidden'); 
                mobilePanel.classList.add('hidden'); mobilePanel.classList.remove('flex');
            }

            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('mob-count').innerText = cart.length;
            
            let total = 0;
            document.getElementById('cart-items').innerHTML = cart.map((r, i) => {
                total += r.price;
                return `
                <div class="flex justify-between items-start border-b border-slate-100 pb-2 last:border-0">
                    <div>
                        <div class="font-bold text-slate-700">${r.firstName}</div>
                        <div class="text-[10px] text-slate-400">${r.distance} | Size ${r.shirtSize}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-slate-900">${r.price}‡∏ø</div>
                        <button onclick="removeRunner(${i})" class="text-[10px] text-red-400 underline">‡∏•‡∏ö</button>
                    </div>
                </div>`;
            }).join('');
            
            const totalStr = total.toLocaleString() + ' ‡∏ø';
            document.getElementById('cart-total').innerText = totalStr;
            document.getElementById('mob-total').innerText = totalStr;
        }

        function removeRunner(i) { cart.splice(i, 1); renderCart(); }

        async function submitAll() {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£?')) return;
            try {
                const regApiUrl = API_URL.replace('/events', '/registrations');
                for (const r of cart) {
                    const { tempId, price, ...data } = r;
                    await fetch(regApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                }
                alert('Success!'); window.location.href = 'index.html';
            } catch (err) { alert('Error'); }
        }

        init();
    </script>
</body>
</html>