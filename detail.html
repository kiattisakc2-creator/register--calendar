<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô - Action.in.th</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#0f172a', 600: '#020617' },
                        accent: { 500: '#22c55e', 600: '#16a34a' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; }
        
        .form-label { font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 0.25rem; display: block; }
        .form-input {
            width: 100%; padding: 0.7rem 1rem;
            border: 1px solid #e2e8f0; border-radius: 0.5rem;
            background-color: #fff; font-size: 0.95rem; transition: all 0.2s;
        }
        .form-input:focus { border-color: #0f172a; outline: none; ring: 1px solid #0f172a; }
        
        /* Ticket Selection */
        .ticket-card {
            border: 2px solid #e2e8f0; padding: 1rem; border-radius: 0.75rem;
            background: white; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;
        }
        .ticket-card:hover { border-color: #94a3b8; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        .ticket-card.selected {
            border-color: #22c55e; background-color: #f0fdf4;
            box-shadow: 0 0 0 1px #22c55e;
        }
        .radio-check {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .ticket-card.selected .radio-check { border-color: #22c55e; background: #22c55e; }
        .ticket-card.selected .radio-check::after { content: '‚úì'; color: white; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-white border-b border-slate-200 h-16 sticky top-0 z-50 shadow-sm flex items-center">
        <div class="container mx-auto px-4 max-w-6xl flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3 font-bold text-xl text-slate-800 hover:text-brand-600 transition">
                <div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-md">A</div>
                <span>Action.in.th</span>
            </a>
            <a href="index.html" class="text-sm font-medium text-slate-500 hover:text-brand-600 flex items-center gap-1 transition">
                ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
        </div>
    </nav>

    <main id="content" class="hidden flex-grow container mx-auto px-4 py-10 max-w-6xl">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm sticky top-24">
                    <img id="event-img" src="" class="w-full h-56 object-cover rounded-xl shadow-sm mb-6 bg-slate-100">
                    
                    <span class="inline-block bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide mb-2">Official Event</span>
                    <h1 id="event-title" class="text-2xl font-bold text-slate-900 mb-4 leading-snug">-</h1>
                    
                    <div class="space-y-3 text-sm text-slate-600 border-t border-slate-100 pt-4">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">üìÖ</span>
                            <div>
                                <p class="font-bold text-slate-800">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô</p>
                                <p id="event-date">-</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="text-lg">üìç</span>
                            <div>
                                <p class="font-bold text-slate-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p>
                                <p id="event-loc">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <form id="regis-form" onsubmit="handleRegister(event)" class="space-y-8">
                    
                    <section class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center text-sm">1</span>
                            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£ (Select Ticket)
                        </h2>
                        
                        <div id="ticket-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            </div>
                        <input type="hidden" id="selected-ticket-idx">
                        <p id="ticket-error" class="hidden text-red-500 text-sm mt-2 font-bold">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£ 1 ‡πÉ‡∏ö</p>
                    </section>

                    <section class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                                <span class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center text-sm">2</span>
                                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (Runner Info)
                            </h2>
                            <button type="button" onclick="resetForm()" class="text-sm text-slate-400 hover:text-red-500 underline">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                            <div><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á (First Name)</label><input type="text" id="reg-fname" class="form-input" required></div>
                            <div><label class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Last Name)</label><input type="text" id="reg-lname" class="form-input" required></div>
                            <div class="md:col-span-2"><label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport</label><input type="text" id="reg-idcard" class="form-input" required></div>
                            <div><label class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input type="date" id="reg-birth" class="form-input" required></div>
                            <div><label class="form-label">‡πÄ‡∏û‡∏®</label><select id="reg-gender" class="form-input"><option value="Male">‡∏ä‡∏≤‡∏¢</option><option value="Female">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
                            <div><label class="form-label">‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥</label><input type="text" id="reg-nation" value="Thai" class="form-input"></div>
                            <div><label class="form-label">‡∏´‡∏°‡∏π‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏î</label><select id="reg-blood" class="form-input"><option value="">-</option><option value="A">A</option><option value="B">B</option><option value="O">O</option><option value="AB">AB</option></select></div>
                        </div>

                        <div class="border-t border-slate-100 pt-6 mb-6">
                            <h3 class="font-bold text-slate-700 mb-4">üè† ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà & ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div class="md:col-span-2"><label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label><input type="text" id="reg-address" class="form-input"></div>
                                <div><label class="form-label">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="reg-province" class="form-input"></div>
                                <div><label class="form-label">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label><input type="text" id="reg-zip" class="form-input"></div>
                                <div><label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="reg-phone" class="form-input" required></div>
                                <div><label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="reg-email" class="form-input" required></div>
                            </div>
                        </div>

                        <div class="border-t border-slate-100 pt-6">
                            <h3 class="font-bold text-slate-700 mb-4">üèÉ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div><label class="form-label">BIB Name (ENG)</label><input type="text" id="reg-bib" class="form-input uppercase" maxlength="10" required></div>
                                <div><label class="form-label">‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠</label><select id="reg-size" class="form-input"><option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>2XL</option></select></div>
                                <div class="md:col-span-2"><label class="form-label">‡∏ä‡∏°‡∏£‡∏°‡∏ß‡∏¥‡πà‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="reg-club" class="form-input"></div>
                                <div class="md:col-span-2"><label class="form-label">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</label><select id="reg-ship" class="form-input"><option value="pickup">‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option><option value="post">‡∏™‡πà‡∏á ‡∏õ‡∏ì. (+50‡∏ö.)</option></select></div>
                            </div>

                            <div class="mt-6 bg-red-50 p-5 rounded-xl border border-red-100">
                                <h4 class="text-sm font-bold text-red-600 uppercase mb-3 flex items-center gap-2">üöë ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Emergency)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label><input type="text" id="reg-em-name" class="form-input bg-white" required></div>
                                    <div><label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label><input type="text" id="reg-em-rel" class="form-input bg-white" required></div>
                                    <div class="md:col-span-2"><label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</label><input type="tel" id="reg-em-phone" class="form-input bg-white" required></div>
                                    <div class="md:col-span-2"><label class="form-label">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß / ‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input type="text" id="reg-med" class="form-input bg-white" value="-"></div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <button type="submit" class="w-full bg-accent-600 hover:bg-accent-500 text-white font-bold text-xl py-4 rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-1 flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (Register Now)
                    </button>

                </form>
            </div>
        </div>
    </main>

    <script src="js/data.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        let currentEvent = null;

        async function init() {
            if (!eventId) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'); window.location.href = 'index.html'; return; }
            try {
                const res = await fetch(`${API_URL}/${eventId}`);
                currentEvent = await res.json();

                // Bind Data
                document.getElementById('event-img').src = currentEvent.image || 'https://via.placeholder.com/800x400';
                document.getElementById('event-title').innerText = currentEvent.title_th;
                document.getElementById('event-date').innerText = currentEvent.date;
                document.getElementById('event-loc').innerText = currentEvent.location_th;

                renderTickets();
                document.getElementById('content').classList.remove('hidden');
            } catch (err) { console.error(err); alert('Failed to load event'); }
        }

        // --- Render Tickets (Cards) ---
        function renderTickets() {
            const container = document.getElementById('ticket-options');
            const today = new Date().toISOString().split('T')[0];
            
            // Handle Schema
            let tickets = currentEvent.tickets?.length > 0 ? currentEvent.tickets : (currentEvent.distance || 'General').split(',').map(d => ({ name: d.trim(), price: Number(currentEvent.price) || 0 }));
            currentEvent.processedTickets = tickets;

            container.innerHTML = tickets.map((t, idx) => {
                let finalPrice = t.price;
                let label = "Normal Price";
                let badgeClass = "bg-slate-100 text-slate-500";

                // Price Logic (Super Early -> Early -> Normal)
                if (t.superEarlyBirdPrice && t.superEarlyBirdDate && today <= t.superEarlyBirdDate) {
                    finalPrice = t.superEarlyBirdPrice;
                    label = "üî• Super Early Bird";
                    badgeClass = "bg-red-100 text-red-600";
                } else if (t.earlyBirdPrice && t.earlyBirdDate && today <= t.earlyBirdDate) {
                    finalPrice = t.earlyBirdPrice;
                    label = "‚ö° Early Bird";
                    badgeClass = "bg-yellow-100 text-yellow-700";
                }

                return `
                <div onclick="selectTicket(${idx})" id="ticket-${idx}" class="ticket-card group relative overflow-hidden">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-bold text-lg text-slate-800">${t.name}</h3>
                            <div class="radio-check"></div>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[10px] ${badgeClass} px-2 py-0.5 rounded font-bold uppercase tracking-wide">${label}</span>
                        </div>
                        <div class="text-2xl font-bold text-accent-600">${finalPrice.toLocaleString()} ‡∏ø</div>
                        ${finalPrice < t.price ? `<div class="text-xs text-slate-400 line-through">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ${t.price.toLocaleString()}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function selectTicket(idx) {
            document.querySelectorAll('.ticket-card').forEach(el => el.classList.remove('selected'));
            document.getElementById(`ticket-${idx}`).classList.add('selected');
            document.getElementById('selected-ticket-idx').value = idx;
            document.getElementById('ticket-error').classList.add('hidden');
        }

        // --- Register Logic (Direct Submit) ---
        async function handleRegister(e) {
            e.preventDefault();
            const idx = document.getElementById('selected-ticket-idx').value;
            
            if (idx === "") { 
                document.getElementById('ticket-error').classList.remove('hidden');
                document.getElementById('ticket-options').scrollIntoView({behavior:'smooth', block:'center'});
                return; 
            }

            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß")) return;

            const btn = document.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

            try {
                // Get Ticket & Price
                const ticket = currentEvent.processedTickets[idx];
                const today = new Date().toISOString().split('T')[0];
                let price = ticket.price;
                if (ticket.superEarlyBirdPrice && ticket.superEarlyBirdDate && today <= ticket.superEarlyBirdDate) price = ticket.superEarlyBirdPrice;
                else if (ticket.earlyBirdPrice && ticket.earlyBirdDate && today <= ticket.earlyBirdDate) price = ticket.earlyBirdPrice;

                // Build Data Object
                const data = {
                    eventId: currentEvent._id,
                    eventName: currentEvent.title_th,
                    distance: ticket.name,
                    price: price, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                    firstName: document.getElementById('reg-fname').value,
                    lastName: document.getElementById('reg-lname').value,
                    nationalId: document.getElementById('reg-idcard').value,
                    birthDate: document.getElementById('reg-birth').value,
                    nationality: document.getElementById('reg-nation').value,
                    bloodType: document.getElementById('reg-blood').value,
                    gender: document.getElementById('reg-gender').value,
                    address: document.getElementById('reg-address').value,
                    province: document.getElementById('reg-province').value,
                    zipcode: document.getElementById('reg-zip').value,
                    phone: document.getElementById('reg-phone').value,
                    email: document.getElementById('reg-email').value,
                    emergencyName: document.getElementById('reg-em-name').value,
                    emergencyRelation: document.getElementById('reg-em-rel').value,
                    emergencyPhone: document.getElementById('reg-em-phone').value,
                    medicalCondition: document.getElementById('reg-med').value,
                    bibName: document.getElementById('reg-bib').value.toUpperCase(),
                    shirtSize: document.getElementById('reg-size').value,
                    runningClub: document.getElementById('reg-club').value,
                    shippingMethod: document.getElementById('reg-ship').value,
                    paymentStatus: 'pending'
                };

                const regApiUrl = API_URL.replace('/events', '/registrations');
                const res = await fetch(regApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('üéâ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Registration Successful)');
                    window.location.href = 'index.html';
                } else {
                    throw new Error('API Error');
                }

            } catch (err) {
                console.error(err);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                btn.disabled = false;
                btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (Register Now)';
            }
        }

        function resetForm() {
            document.getElementById('regis-form').reset();
            document.querySelectorAll('.ticket-card').forEach(el => el.classList.remove('selected'));
            document.getElementById('selected-ticket-idx').value = "";
            window.scrollTo({top:0, behavior:'smooth'});
        }

        init();
    </script>
</body>
</html>