<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô - Action.in.th</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#0f172a', 600: '#020617' }, // ‡∏™‡∏µ‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤ (Theme ‡∏´‡∏•‡∏±‡∏Å)
                        accent: { 500: '#16a34a', 600: '#15803d' } // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (Action)
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; }
        
        /* Input & Labels */
        .form-label { font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 0.25rem; display: block; }
        .form-input {
            width: 100%; padding: 0.6rem 0.8rem;
            border: 1px solid #cbd5e1; border-radius: 0.5rem;
            background-color: #fff; font-size: 0.95rem; transition: all 0.2s;
        }
        .form-input:focus { border-color: #0f172a; outline: none; ring: 1px solid #0f172a; }
        
        /* Ticket Card */
        .ticket-item {
            border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.75rem;
            background: white; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .ticket-item:hover { border-color: #94a3b8; transform: translateY(-1px); }
        .ticket-item.selected {
            border-color: #16a34a; background-color: #f0fdf4; box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.2); ring: 1px solid #16a34a;
        }
        .check-circle {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center;
        }
        .ticket-item.selected .check-circle { border-color: #16a34a; background: #16a34a; color: white; }
        .ticket-item.selected .check-circle::after { content: '‚úì'; font-size: 14px; font-weight: bold; }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body class="flex flex-col min-h-screen pb-24 lg:pb-0">

    <nav class="bg-white border-b border-slate-200 h-16 sticky top-0 z-50 shadow-sm flex items-center">
        <div class="container mx-auto px-4 max-w-5xl flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 font-bold text-lg text-slate-800">
                <div class="w-8 h-8 bg-slate-900 text-white rounded-lg flex items-center justify-center font-bold">A</div>
                Action.in.th
            </a>
            <a href="index.html" class="text-sm font-medium text-slate-500 hover:text-red-600 transition">‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
        </div>
    </nav>

    <main id="content" class="hidden flex-grow container mx-auto px-4 py-8 max-w-5xl">
        
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 mb-8 flex flex-col md:flex-row gap-6 items-center md:items-start">
            <img id="event-img" src="" class="w-full md:w-64 h-40 object-cover rounded-xl bg-slate-100 shadow-sm border border-slate-100">
            <div class="flex-1 w-full pt-1">
                <div class="flex items-center justify-between mb-2">
                    <span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Official Event</span>
                </div>
                <h1 id="event-title" class="text-2xl md:text-3xl font-bold text-slate-900 mb-3 leading-tight">Loading...</h1>
                <div class="flex flex-wrap gap-4 text-sm text-slate-500">
                    <span class="flex items-center gap-1">üìÖ <b id="event-date" class="text-slate-700">-</b></span>
                    <span class="flex items-center gap-1">üìç <b id="event-loc" class="text-slate-700">-</b></span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <div class="lg:col-span-7 space-y-6">
                
                <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                        <span class="bg-slate-900 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£
                    </h2>
                    <div id="ticket-options" class="space-y-3"></div>
                    <input type="hidden" id="selected-ticket-idx">
                    <p id="ticket-error" class="hidden text-red-500 text-sm mt-2 font-bold animate-pulse">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </section>

                <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-3">
                        <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                            <span class="bg-slate-900 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                        </h2>
                        <button type="button" onclick="resetForm()" class="text-xs text-slate-400 hover:text-red-500 underline">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                    </div>

                    <form id="runner-form" onsubmit="addToCart(event)" class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2 md:col-span-1"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á (First Name)</label><input type="text" id="reg-fname" class="form-input" required></div>
                            <div class="col-span-2 md:col-span-1"><label class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Last Name)</label><input type="text" id="reg-lname" class="form-input" required></div>
                            <div class="col-span-2"><label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport</label><input type="text" id="reg-idcard" class="form-input" required></div>
                            <div><label class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input type="date" id="reg-birth" class="form-input" required></div>
                            <div><label class="form-label">‡πÄ‡∏û‡∏®</label><select id="reg-gender" class="form-input"><option value="Male">‡∏ä‡∏≤‡∏¢</option><option value="Female">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
                            <div><label class="form-label">‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥</label><input type="text" id="reg-nation" value="Thai" class="form-input"></div>
                            <div><label class="form-label">‡∏´‡∏°‡∏π‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏î</label><select id="reg-blood" class="form-input"><option value="">-</option><option value="A">A</option><option value="B">B</option><option value="O">O</option><option value="AB">AB</option></select></div>
                        </div>

                        <div class="pt-4 border-t border-slate-100">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2"><label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label><input type="text" id="reg-address" class="form-input"></div>
                                <div><label class="form-label">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="reg-province" class="form-input"></div>
                                <div><label class="form-label">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label><input type="text" id="reg-zip" class="form-input"></div>
                                <div><label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="reg-phone" class="form-input" required></div>
                                <div><label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="reg-email" class="form-input" required></div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-slate-100">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1"><label class="form-label">BIB Name (ENG)</label><input type="text" id="reg-bib" class="form-input uppercase" maxlength="10" required></div>
                                <div class="col-span-2 md:col-span-1"><label class="form-label">‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠</label><select id="reg-size" class="form-input"><option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>2XL</option></select></div>
                                <div class="col-span-2"><label class="form-label">‡∏ä‡∏°‡∏£‡∏°‡∏ß‡∏¥‡πà‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="reg-club" class="form-input"></div>
                                <div class="col-span-2"><label class="form-label">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</label><select id="reg-ship" class="form-input"><option value="pickup">‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option><option value="post">‡∏™‡πà‡∏á ‡∏õ‡∏ì. (+50‡∏ö.)</option></select></div>
                            </div>
                            
                            <div class="mt-4 p-4 bg-red-50 rounded-xl border border-red-100">
                                <h4 class="text-xs font-bold text-red-600 uppercase mb-3 flex items-center gap-1">üöë ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Emergency Contact)</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="text" id="reg-em-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="form-input bg-white" required>
                                    <input type="text" id="reg-em-rel" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå" class="form-input bg-white" required>
                                    <input type="tel" id="reg-em-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô" class="form-input bg-white col-span-2" required>
                                    <input type="text" id="reg-med" placeholder="‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß/‡πÅ‡∏û‡πâ‡∏¢‡∏≤" class="form-input bg-white col-span-2" value="-">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="w-full py-3 bg-slate-900 hover:bg-black text-white font-bold rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                            <span>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
                        </button>
                    </form>
                </section>
            </div>

            <div class="lg:col-span-5 relative">
                <div class="sticky top-24 bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden cart-desktop">
                    <div class="bg-slate-900 text-white p-4 flex justify-between items-center">
                        <h3 class="font-bold flex items-center gap-2">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <span id="cart-count" class="bg-accent-500 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>
                    
                    <div id="cart-items" class="p-4 space-y-3 max-h-[50vh] overflow-y-auto bg-slate-50 min-h-[150px] custom-scroll">
                        <div id="cart-empty" class="text-center py-10 text-slate-400 text-sm">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </div>
                    </div>

                    <div class="p-5 border-t border-slate-200 bg-white">
                        <div class="flex justify-between items-end mb-4">
                            <span class="text-sm text-slate-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <span class="text-2xl font-bold text-accent-600" id="cart-total">0 ‡∏ø</span>
                        </div>
                        <button onclick="submitAll()" class="w-full bg-accent-600 hover:bg-accent-700 text-white font-bold py-3 rounded-xl shadow-lg transition">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div class="cart-mobile fixed bottom-0 w-full bg-white border-t p-3 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-50 flex justify-between items-center lg:hidden">
        <div>
            <div class="text-[10px] text-slate-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (<span id="mob-count">0</span>)</div>
            <div class="text-lg font-bold text-accent-600" id="mob-total">0 ‡∏ø</div>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('ticket-options').scrollIntoView({behavior:'smooth'})" class="px-4 py-2 border rounded-lg text-xs font-bold bg-white text-slate-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å</button>
            <button onclick="submitAll()" class="px-5 py-2 bg-accent-600 text-white rounded-lg text-xs font-bold shadow">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        let currentEvent = null, cart = [];

        async function init() {
            if (!eventId) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'); window.location.href = 'index.html'; return; }
            try {
                const res = await fetch(`${API_URL}/${eventId}`);
                currentEvent = await res.json();

                document.getElementById('event-img').src = currentEvent.image || 'https://via.placeholder.com/800x400';
                document.getElementById('event-title').innerText = currentEvent.title_th;
                document.getElementById('event-date').innerText = currentEvent.date;
                document.getElementById('event-loc').innerText = currentEvent.location_th;

                renderTickets();
                document.getElementById('content').classList.remove('hidden');
            } catch (err) { console.error(err); alert('Failed to load event'); }
        }

        // --- Multi-Tier Price Logic ---
        function renderTickets() {
            const container = document.getElementById('ticket-options');
            const today = new Date().toISOString().split('T')[0];
            
            // Handle Schema (New vs Old)
            let tickets = currentEvent.tickets?.length > 0 ? currentEvent.tickets : (currentEvent.distance || 'General').split(',').map(d => ({ name: d.trim(), price: Number(currentEvent.price) || 0 }));
            currentEvent.processedTickets = tickets;

            container.innerHTML = tickets.map((t, idx) => {
                let finalPrice = t.price;
                let label = "Normal Price";
                let deadline = "";

                // Check Price Tier Priority (Super Early -> Early -> Normal)
                if (t.superEarlyBirdPrice && t.superEarlyBirdDate && today <= t.superEarlyBirdDate) {
                    finalPrice = t.superEarlyBirdPrice;
                    label = "üî• Super Early Bird";
                    deadline = t.superEarlyBirdDate;
                } else if (t.earlyBirdPrice && t.earlyBirdDate && today <= t.earlyBirdDate) {
                    finalPrice = t.earlyBirdPrice;
                    label = "‚ö° Early Bird";
                    deadline = t.earlyBirdDate;
                }

                return `
                <div onclick="selectTicket(${idx})" id="ticket-${idx}" class="ticket-item group">
                    <div class="flex items-center gap-3">
                        <div class="check-circle"></div>
                        <div>
                            <div class="font-bold text-slate-800 text-lg">${t.name}</div>
                            <div class="flex gap-2 items-center mt-1">
                                <span class="text-[10px] ${label.includes('Normal') ? 'bg-slate-100 text-slate-500' : 'bg-red-100 text-red-600'} px-1.5 py-0.5 rounded font-bold">${label}</span>
                                ${deadline ? `<span class="text-[10px] text-slate-400">‡∏ñ‡∏∂‡∏á ${deadline}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        ${finalPrice < t.price ? `<div class="text-[10px] text-slate-400 line-through">${t.price}</div>` : ''}
                        <div class="font-bold text-accent-600 text-xl">${finalPrice.toLocaleString()} ‡∏ø</div>
                    </div>
                </div>`;
            }).join('');
        }

        function selectTicket(idx) {
            document.querySelectorAll('.ticket-item').forEach(el => el.classList.remove('selected'));
            document.getElementById(`ticket-${idx}`).classList.add('selected');
            document.getElementById('selected-ticket-idx').value = idx;
            document.getElementById('ticket-error').classList.add('hidden');
        }

        function addToCart(e) {
            e.preventDefault();
            const idx = document.getElementById('selected-ticket-idx').value;
            
            if (idx === "") { 
                document.getElementById('ticket-error').classList.remove('hidden');
                document.getElementById('ticket-options').scrollIntoView({behavior:'smooth', block:'center'});
                return; 
            }

            try {
                const ticket = currentEvent.processedTickets[idx];
                const today = new Date().toISOString().split('T')[0];
                let price = ticket.price;
                if (ticket.superEarlyBirdPrice && ticket.superEarlyBirdDate && today <= ticket.superEarlyBirdDate) {
                    price = ticket.superEarlyBirdPrice;
                } else if (ticket.earlyBirdPrice && ticket.earlyBirdDate && today <= ticket.earlyBirdDate) {
                    price = ticket.earlyBirdPrice;
                }

                // Collect Data (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß)
                const runner = {
                    tempId: Date.now(),
                    eventId: currentEvent._id,
                    eventName: currentEvent.title_th,
                    distance: ticket.name,
                    price: price,
                    firstName: document.getElementById('reg-fname').value,
                    lastName: document.getElementById('reg-lname').value,
                    nationalId: document.getElementById('reg-idcard').value,
                    birthDate: document.getElementById('reg-birth').value,
                    nationality: document.getElementById('reg-nation').value,
                    bloodType: document.getElementById('reg-blood').value,
                    gender: document.getElementById('reg-gender').value,
                    address: document.getElementById('reg-address').value,
                    province: document.getElementById('reg-province').value,
                    zipcode: document.getElementById('reg-zip').value,
                    phone: document.getElementById('reg-phone').value,
                    email: document.getElementById('reg-email').value,
                    emergencyName: document.getElementById('reg-em-name').value,
                    emergencyRelation: document.getElementById('reg-em-rel').value,
                    emergencyPhone: document.getElementById('reg-em-phone').value,
                    medicalCondition: document.getElementById('reg-med').value,
                    bibName: document.getElementById('reg-bib').value.toUpperCase(),
                    shirtSize: document.getElementById('reg-size').value,
                    runningClub: document.getElementById('reg-club').value,
                    shippingMethod: document.getElementById('reg-ship').value,
                    paymentStatus: 'pending'
                };

                cart.push(runner);
                renderCart();
                resetForm();
                alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');

            } catch (err) {
                console.error("Add to cart failed:", err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
            }
        }

        function resetForm() {
            ['reg-fname','reg-lname','reg-idcard','reg-bib','reg-club'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('selected-ticket-idx').value = "";
            document.querySelectorAll('.ticket-item').forEach(el => el.classList.remove('selected'));
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function renderCart() {
            const emptyMsg = document.getElementById('cart-empty');
            const itemsDiv = document.getElementById('cart-items');
            
            if (cart.length > 0) { 
                emptyMsg.classList.add('hidden'); 
                document.querySelector('.cart-desktop').classList.remove('hidden');
            } else { 
                emptyMsg.classList.remove('hidden'); 
            }

            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('mob-count').innerText = cart.length;
            
            let total = 0;
            itemsDiv.innerHTML = cart.map((r, i) => {
                total += r.price;
                return `
                <div class="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-bold">${i+1}</div>
                        <div>
                            <div class="font-bold text-slate-800 text-sm">${r.firstName}</div>
                            <div class="text-[10px] text-slate-500">${r.distance} ‚Ä¢ ${r.shirtSize}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-accent-600 text-sm">${r.price.toLocaleString()} ‡∏ø</div>
                        <button onclick="removeRunner(${i})" class="text-[10px] text-red-400 underline hover:text-red-600">‡∏•‡∏ö</button>
                    </div>
                </div>`;
            }).join('');
            
            const totalStr = total.toLocaleString() + ' ‡∏ø';
            document.getElementById('cart-total').innerText = totalStr;
            document.getElementById('mob-total').innerText = totalStr;
        }

        function removeRunner(i) { cart.splice(i, 1); renderCart(); }

        async function submitAll() {
            if (cart.length === 0) { alert('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤!'); return; }
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cart.length} ‡∏ó‡πà‡∏≤‡∏ô?`)) return;

            const btns = document.querySelectorAll('button');
            btns.forEach(b => { b.disabled = true; });

            try {
                const regApiUrl = API_URL.replace('/events', '/registrations');
                for (const runner of cart) {
                    const { tempId, price, ...data } = runner;
                    await fetch(regApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                }
                alert('üéâ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! (Success)');
                window.location.href = 'index.html';
            } catch (err) {
                console.error(err);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                btns.forEach(b => { b.disabled = false; });
            }
        }

        init();
    </script>
</body>
</html>