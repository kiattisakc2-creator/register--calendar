<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body{font-family:'Prompt',sans-serif;}</style>
    <style>
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800">

    <div id="login-section" class="fixed inset-0 bg-slate-800 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-8 rounded-2xl shadow-2xl text-center">
            <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="password" id="admin-pass" class="w-full px-4 py-3 rounded-xl border border-slate-300 text-center" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (1234)">
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
        </div>
    </div>

    <div id="dashboard-section" class="hidden p-6 md:p-10">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Admin Dashboard üõ†Ô∏è</h1>
                <div class="flex gap-3">
                    <a href="../index.html" target="_blank" class="bg-white border px-4 py-2 rounded-lg hover:bg-slate-50 text-sm font-bold">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</a>
                    <button onclick="logout()" class="bg-red-50 text-red-600 border border-red-100 px-4 py-2 rounded-lg hover:bg-red-100 text-sm font-bold">Logout</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow border border-slate-200 overflow-x-auto">
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="p-4">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th>
                            <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="p-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="event-table-body">
                        <tr><td colspan="4" class="p-10 text-center text-slate-400">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeEditModal()"></div>
        
        <div class="relative bg-white w-full max-w-lg mx-auto mt-20 rounded-xl shadow-2xl p-6 z-50 animate-bounce-in">
            <h3 class="text-xl font-bold mb-4 text-slate-800">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á ‚úèÔ∏è</h3>
            
            <form onsubmit="handleEditSubmit(event)" class="space-y-4">
                <input type="hidden" id="edit-id"> <div>
                    <label class="block text-sm font-bold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô (TH)</label>
                    <input type="text" id="edit-title" class="w-full border p-2 rounded-lg" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="edit-date" class="w-full border p-2 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                        <select id="edit-province" class="w-full border p-2 rounded-lg">
                            <option value="Bangkok">Bangkok</option>
                            <option value="Chiang Mai">Chiang Mai</option>
                            <option value="Phuket">Phuket</option>
                            <option value="Chonburi">Chonburi</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                    <input type="text" id="edit-submitter" class="w-full border p-2 rounded-lg">
                </div>

                <div class="flex justify-end gap-2 pt-4 border-t mt-4">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script>
        const ADMIN_PASS = "1234";

        // --- AUTH SYSTEM ---
        function checkAuth() {
            const isAuth = sessionStorage.getItem("isAdmin") === "true";
            if (isAuth) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                fetchAdminEvents();
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('dashboard-section').classList.add('hidden');
            }
        }
        function handleLogin(e) {
            e.preventDefault();
            if (document.getElementById('admin-pass').value === ADMIN_PASS) {
                sessionStorage.setItem("isAdmin", "true");
                checkAuth();
            } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!");
        }
        function logout() {
            sessionStorage.removeItem("isAdmin");
            window.location.reload();
        }

        // --- DATA FETCHING ---
        async function fetchAdminEvents() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                renderTable(data);
            } catch (err) { console.error(err); }
        }

        function renderTable(events) {
            const tbody = document.getElementById('event-table-body');
            if(!events.length) { tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }

            tbody.innerHTML = events.map(e => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-4 text-sm">${e.date}</td>
                    <td class="p-4 font-bold text-slate-700">${e.title_th}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-xs font-bold border ${e.status==='open'?'bg-green-50 text-green-700 border-green-200':'bg-red-50 text-red-700 border-red-200'}">
                            ${e.status||'open'}
                        </span>
                    </td>
                    <td class="p-4 text-center flex justify-center gap-1">
                        <button onclick='openEditModal(${JSON.stringify(e).replace(/'/g, "&#39;")})' class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-xs hover:bg-yellow-200 font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        
                        ${e.status!=='open' 
                            ? `<button onclick="updateStatus('${e._id}','open')" class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs hover:bg-green-200 font-bold">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</button>` 
                            : `<button onclick="updateStatus('${e._id}','closed')" class="bg-slate-100 text-slate-600 px-3 py-1 rounded text-xs hover:bg-slate-200 font-bold">‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</button>`
                        }
                        <button onclick="deleteEvent('${e._id}')" class="bg-red-100 text-red-600 px-3 py-1 rounded text-xs hover:bg-red-200 font-bold">‡∏•‡∏ö</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- EDIT LOGIC (‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà) ---
        function openEditModal(eventData) {
            // ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input
            document.getElementById('edit-id').value = eventData._id;
            document.getElementById('edit-title').value = eventData.title_th;
            document.getElementById('edit-date').value = eventData.date;
            document.getElementById('edit-province').value = eventData.location_th || 'Bangkok';
            document.getElementById('edit-submitter').value = eventData.submitter || '';

            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            const updateData = {
                title_th: document.getElementById('edit-title').value,
                title_en: document.getElementById('edit-title').value, // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏î‡πâ‡∏ß‡∏¢
                date: document.getElementById('edit-date').value,
                location_th: document.getElementById('edit-province').value,
                location_en: document.getElementById('edit-province').value,
                submitter: document.getElementById('edit-submitter').value
            };

            try {
                // ‡∏™‡πà‡∏á‡πÑ‡∏õ Backend (PATCH)
                const res = await fetch(`${API_URL}/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if(res.ok) {
                    alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                    closeEditModal();
                    fetchAdminEvents(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
            } catch(err) { alert('Server Error'); }
        }

        // --- ACTIONS ---
        async function updateStatus(id, st) {
            if(confirm('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞?')) {
                await fetch(`${API_URL}/${id}`, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify({status:st}) });
                fetchAdminEvents();
            }
        }
        async function deleteEvent(id) {
            if(confirm('‡∏•‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ô‡∏∞?')) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                fetchAdminEvents();
            }
        }

        checkAuth();
    </script>
</body>
</html>